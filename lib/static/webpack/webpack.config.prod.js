"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = _default;

var _webpack = _interopRequireDefault(require("webpack"));

var _path = _interopRequireDefault(require("path"));

var _caseSensitivePathsWebpackPlugin = _interopRequireDefault(require("case-sensitive-paths-webpack-plugin"));

var _webpackBundleAnalyzer = require("webpack-bundle-analyzer");

var _uglifyjsWebpackPlugin = _interopRequireDefault(require("uglifyjs-webpack-plugin"));

var _webpackNodeExternals = _interopRequireDefault(require("webpack-node-externals"));

var _extractCssChunksWebpackPlugin = _interopRequireDefault(require("extract-css-chunks-webpack-plugin"));

var _optimizeCssAssetsWebpackPlugin = _interopRequireDefault(require("optimize-css-assets-webpack-plugin"));

var _rules = _interopRequireDefault(require("./rules"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function common(config) {
  var _config$paths = config.paths,
      ROOT = _config$paths.ROOT,
      DIST = _config$paths.DIST,
      NODE_MODULES = _config$paths.NODE_MODULES,
      SRC = _config$paths.SRC,
      ASSETS = _config$paths.ASSETS;
  process.env.REACT_STATIC_SITE_ROOT = config.siteRoot;
  process.env.REACT_STATIC_BASE_PATH = config.basePath;
  process.env.REACT_STATIC_PUBLIC_PATH = config.publicPath;
  process.env.REACT_STATIC_ASSETS_PATH = config.assetsPath;
  var splitChunks = {
    chunks: 'all',
    minSize: 10000,
    minChunks: 1,
    maxAsyncRequests: 5,
    maxInitialRequests: 5,
    automaticNameDelimiter: '~',
    name: true,
    cacheGroups: {
      vendors: {
        test: /[\\/]node_modules[\\/]/,
        priority: -10,
        chunks: 'all'
      },
      default: {
        minChunks: 2,
        priority: -20,
        reuseExistingChunk: true
      }
    }
  };
  var extrackCSSChunks = new _extractCssChunksWebpackPlugin.default({
    filename: '[name].[chunkHash:8].css',
    chunkFilename: '[id].[chunkHash:8].css'
  });

  if (!config.extractCssChunks) {
    splitChunks.cacheGroups = {
      styles: {
        name: 'styles',
        test: /\.css$/,
        chunks: 'all',
        enforce: true
      }
    };
    extrackCSSChunks = new _extractCssChunksWebpackPlugin.default({
      filename: '[name].[chunkHash:8].css'
    });
  }

  return {
    mode: 'production',
    context: _path.default.resolve(__dirname, '../../../node_modules'),
    entry: _path.default.resolve(ROOT, config.entry),
    output: {
      filename: '[name].[hash:8].js',
      // dont use chunkhash, its not a chunk
      chunkFilename: 'templates/[name].[chunkHash:8].js',
      path: ASSETS,
      publicPath: process.env.REACT_STATIC_ASSETS_PATH || '/'
    },
    optimization: {
      minimize: true,
      minimizer: [new _uglifyjsWebpackPlugin.default({
        cache: true,
        parallel: true,
        sourceMap: true // set to true if you want JS source maps

      }), new _optimizeCssAssetsWebpackPlugin.default({})],
      splitChunks: splitChunks
    },
    module: {
      rules: (0, _rules.default)({
        config: config,
        stage: 'prod',
        isNode: false
      })
    },
    resolve: {
      modules: [SRC, NODE_MODULES, 'node_modules', _path.default.resolve(__dirname, '../../../node_modules'), DIST],
      mainFields: ['browser', 'main'],
      extensions: ['.js', '.json', '.jsx']
    },
    externals: [],
    target: undefined,
    plugins: [new _webpack.default.EnvironmentPlugin(process.env), extrackCSSChunks, new _caseSensitivePathsWebpackPlugin.default(), config.bundleAnalyzer && new _webpackBundleAnalyzer.BundleAnalyzerPlugin()].filter(function (d) {
      return d;
    }),
    devtool: 'source-map'
  };
}

function _default(_ref) {
  var config = _ref.config,
      isNode = _ref.isNode;
  var result = common(config);
  if (!isNode) return result;
  result.output.filename = 'static.[chunkHash:8].js';
  result.output.libraryTarget = 'umd';
  result.optimization.minimize = false;
  result.optimization.minimizer = [];
  result.target = 'node';
  result.externals = [(0, _webpackNodeExternals.default)({
    whitelist: ['react-universal-component', 'webpack-flush-chunks', 'react-static-routes']
  })]; //
  // module.rules

  result.module.rules = (0, _rules.default)({
    config: config,
    stage: 'prod',
    isNode: true
  });
  result.plugins = [new _webpack.default.EnvironmentPlugin(process.env), new _caseSensitivePathsWebpackPlugin.default(), new _webpack.default.optimize.LimitChunkCountPlugin({
    maxChunks: 1
  })];
  return result;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zdGF0aWMvd2VicGFjay93ZWJwYWNrLmNvbmZpZy5wcm9kLmpzIl0sIm5hbWVzIjpbImNvbW1vbiIsImNvbmZpZyIsInBhdGhzIiwiUk9PVCIsIkRJU1QiLCJOT0RFX01PRFVMRVMiLCJTUkMiLCJBU1NFVFMiLCJwcm9jZXNzIiwiZW52IiwiUkVBQ1RfU1RBVElDX1NJVEVfUk9PVCIsInNpdGVSb290IiwiUkVBQ1RfU1RBVElDX0JBU0VfUEFUSCIsImJhc2VQYXRoIiwiUkVBQ1RfU1RBVElDX1BVQkxJQ19QQVRIIiwicHVibGljUGF0aCIsIlJFQUNUX1NUQVRJQ19BU1NFVFNfUEFUSCIsImFzc2V0c1BhdGgiLCJzcGxpdENodW5rcyIsImNodW5rcyIsIm1pblNpemUiLCJtaW5DaHVua3MiLCJtYXhBc3luY1JlcXVlc3RzIiwibWF4SW5pdGlhbFJlcXVlc3RzIiwiYXV0b21hdGljTmFtZURlbGltaXRlciIsIm5hbWUiLCJjYWNoZUdyb3VwcyIsInZlbmRvcnMiLCJ0ZXN0IiwicHJpb3JpdHkiLCJkZWZhdWx0IiwicmV1c2VFeGlzdGluZ0NodW5rIiwiZXh0cmFja0NTU0NodW5rcyIsIkV4dHJhY3RDc3NDaHVua3MiLCJmaWxlbmFtZSIsImNodW5rRmlsZW5hbWUiLCJleHRyYWN0Q3NzQ2h1bmtzIiwic3R5bGVzIiwiZW5mb3JjZSIsIm1vZGUiLCJjb250ZXh0IiwicGF0aCIsInJlc29sdmUiLCJfX2Rpcm5hbWUiLCJlbnRyeSIsIm91dHB1dCIsIm9wdGltaXphdGlvbiIsIm1pbmltaXplIiwibWluaW1pemVyIiwiVWdsaWZ5SnNQbHVnaW4iLCJjYWNoZSIsInBhcmFsbGVsIiwic291cmNlTWFwIiwiT3B0aW1pemVDU1NBc3NldHNQbHVnaW4iLCJtb2R1bGUiLCJydWxlcyIsInN0YWdlIiwiaXNOb2RlIiwibW9kdWxlcyIsIm1haW5GaWVsZHMiLCJleHRlbnNpb25zIiwiZXh0ZXJuYWxzIiwidGFyZ2V0IiwidW5kZWZpbmVkIiwicGx1Z2lucyIsIndlYnBhY2siLCJFbnZpcm9ubWVudFBsdWdpbiIsIkNhc2VTZW5zaXRpdmVQYXRoc1BsdWdpbiIsImJ1bmRsZUFuYWx5emVyIiwiQnVuZGxlQW5hbHl6ZXJQbHVnaW4iLCJmaWx0ZXIiLCJkIiwiZGV2dG9vbCIsInJlc3VsdCIsImxpYnJhcnlUYXJnZXQiLCJ3aGl0ZWxpc3QiLCJvcHRpbWl6ZSIsIkxpbWl0Q2h1bmtDb3VudFBsdWdpbiIsIm1heENodW5rcyJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOzs7O0FBRUEsU0FBU0EsTUFBVCxDQUFnQkMsTUFBaEIsRUFBd0I7QUFBQSxzQkFDNEJBLE1BQU0sQ0FBQ0MsS0FEbkM7QUFBQSxNQUNkQyxJQURjLGlCQUNkQSxJQURjO0FBQUEsTUFDUkMsSUFEUSxpQkFDUkEsSUFEUTtBQUFBLE1BQ0ZDLFlBREUsaUJBQ0ZBLFlBREU7QUFBQSxNQUNZQyxHQURaLGlCQUNZQSxHQURaO0FBQUEsTUFDaUJDLE1BRGpCLGlCQUNpQkEsTUFEakI7QUFHdEJDLEVBQUFBLE9BQU8sQ0FBQ0MsR0FBUixDQUFZQyxzQkFBWixHQUFxQ1QsTUFBTSxDQUFDVSxRQUE1QztBQUNBSCxFQUFBQSxPQUFPLENBQUNDLEdBQVIsQ0FBWUcsc0JBQVosR0FBcUNYLE1BQU0sQ0FBQ1ksUUFBNUM7QUFDQUwsRUFBQUEsT0FBTyxDQUFDQyxHQUFSLENBQVlLLHdCQUFaLEdBQXVDYixNQUFNLENBQUNjLFVBQTlDO0FBQ0FQLEVBQUFBLE9BQU8sQ0FBQ0MsR0FBUixDQUFZTyx3QkFBWixHQUF1Q2YsTUFBTSxDQUFDZ0IsVUFBOUM7QUFFQSxNQUFNQyxXQUFXLEdBQUc7QUFDbEJDLElBQUFBLE1BQU0sRUFBRSxLQURVO0FBRWxCQyxJQUFBQSxPQUFPLEVBQUUsS0FGUztBQUdsQkMsSUFBQUEsU0FBUyxFQUFFLENBSE87QUFJbEJDLElBQUFBLGdCQUFnQixFQUFFLENBSkE7QUFLbEJDLElBQUFB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Q0FBQ25CLE1BQVAsQ0FBY0MsS0FBZCxHQUFzQixvQkFBTTtBQUFFdEQsSUFBQUEsTUFBTSxFQUFOQSxNQUFGO0FBQVV1RCxJQUFBQSxLQUFLLEVBQUUsTUFBakI7QUFBeUJDLElBQUFBLE1BQU0sRUFBRTtBQUFqQyxHQUFOLENBQXRCO0FBQ0FnQixFQUFBQSxNQUFNLENBQUNULE9BQVAsR0FBaUIsQ0FDZixJQUFJQyxpQkFBUUMsaUJBQVosQ0FBOEIxRCxPQUFPLENBQUNDLEdBQXRDLENBRGUsRUFFZixJQUFJMEQsd0NBQUosRUFGZSxFQUdmLElBQUlGLGlCQUFRVyxRQUFSLENBQWlCQyxxQkFBckIsQ0FBMkM7QUFDekNDLElBQUFBLFNBQVMsRUFBRTtBQUQ4QixHQUEzQyxDQUhlLENBQWpCO0FBT0EsU0FBT0wsTUFBUDtBQUNEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHdlYnBhY2sgZnJvbSAnd2VicGFjaydcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnXG5pbXBvcnQgQ2FzZVNlbnNpdGl2ZVBhdGhzUGx1Z2luIGZyb20gJ2Nhc2Utc2Vuc2l0aXZlLXBhdGhzLXdlYnBhY2stcGx1Z2luJ1xuaW1wb3J0IHsgQnVuZGxlQW5hbHl6ZXJQbHVnaW4gfSBmcm9tICd3ZWJwYWNrLWJ1bmRsZS1hbmFseXplcidcbmltcG9ydCBVZ2xpZnlKc1BsdWdpbiBmcm9tICd1Z2xpZnlqcy13ZWJwYWNrLXBsdWdpbidcbmltcG9ydCBub2RlRXh0ZXJuYWxzIGZyb20gJ3dlYnBhY2stbm9kZS1leHRlcm5hbHMnXG5pbXBvcnQgRXh0cmFjdENzc0NodW5rcyBmcm9tICdleHRyYWN0LWNzcy1jaHVua3Mtd2VicGFjay1wbHVnaW4nXG5pbXBvcnQgT3B0aW1pemVDU1NBc3NldHNQbHVnaW4gZnJvbSAnb3B0aW1pemUtY3NzLWFzc2V0cy13ZWJwYWNrLXBsdWdpbidcbmltcG9ydCBydWxlcyBmcm9tICcuL3J1bGVzJ1xuXG5mdW5jdGlvbiBjb21tb24oY29uZmlnKSB7XG4gIGNvbnN0IHsgUk9PVCwgRElTVCwgTk9ERV9NT0RVTEVTLCBTUkMsIEFTU0VUUyB9ID0gY29uZmlnLnBhdGhzXG5cbiAgcHJvY2Vzcy5lbnYuUkVBQ1RfU1RBVElDX1NJVEVfUk9PVCA9IGNvbmZpZy5zaXRlUm9vdFxuICBwcm9jZXNzLmVudi5SRUFDVF9TVEFUSUNfQkFTRV9QQVRIID0gY29uZmlnLmJhc2VQYXRoXG4gIHByb2Nlc3MuZW52LlJFQUNUX1NUQVRJQ19QVUJMSUNfUEFUSCA9IGNvbmZpZy5wdWJsaWNQYXRoXG4gIHByb2Nlc3MuZW52LlJFQUNUX1NUQVRJQ19BU1NFVFNfUEFUSCA9IGNvbmZpZy5hc3NldHNQYXRoXG5cbiAgY29uc3Qgc3BsaXRDaHVua3MgPSB7XG4gICAgY2h1bmtzOiAnYWxsJyxcbiAgICBtaW5TaXplOiAxMDAwMCxcbiAgICBtaW5DaHVua3M6IDEsXG4gICAgbWF4QXN5bmNSZXF1ZXN0czogNSxcbiAgICBtYXhJbml0aWFsUmVxdWVzdHM6IDUsXG4gICAgYXV0b21hdGljTmFtZURlbGltaXRlcjogJ34nLFxuICAgIG5hbWU6IHRydWUsXG4gICAgY2FjaGVHcm91cHM6IHtcbiAgICAgIHZlbmRvcnM6IHtcbiAgICAgICAgdGVzdDogL1tcXFxcL11ub2RlX21vZHVsZXNbXFxcXC9dLyxcbiAgICAgICAgcHJpb3JpdHk6IC0xMCxcbiAgICAgICAgY2h1bmtzOiAnYWxsJyxcbiAgICAgIH0sXG4gICAgICBkZWZhdWx0OiB7XG4gICAgICAgIG1pbkNodW5rczogMixcbiAgICAgICAgcHJpb3JpdHk6IC0yMCxcbiAgICAgICAgcmV1c2VFeGlzdGluZ0NodW5rOiB0cnVlLFxuICAgICAgfSxcbiAgICB9LFxuICB9XG5cbiAgbGV0IGV4dHJhY2tDU1NDaHVua3MgPSBuZXcgRXh0cmFjdENzc0NodW5rcyh7XG4gICAgZmlsZW5hbWU6ICdbbmFtZV0uW2NodW5rSGFzaDo4XS5jc3MnLFxuICAgIGNodW5rRmlsZW5hbWU6ICdbaWRdLltjaHVua0hhc2g6OF0uY3NzJyxcbiAgfSlcblxuICBpZiAoIWNvbmZpZy5leHRyYWN0Q3NzQ2h1bmtzKSB7XG4gICAgc3BsaXRDaHVua3MuY2FjaGVHcm91cHMgPSB7XG4gICAgICBzdHlsZXM6IHtcbiAgICAgICAgbmFtZTogJ3N0eWxlcycsXG4gICAgICAgIHRlc3Q6IC9cXC5jc3MkLyxcbiAgICAgICAgY2h1bmtzOiAnYWxsJyxcbiAgICAgICAgZW5mb3JjZTogdHJ1ZSxcbiAgICAgIH0sXG4gICAgfVxuICAgIGV4dHJhY2tDU1NDaHVua3MgPSBuZXcgRXh0cmFjdENzc0NodW5rcyh7XG4gICAgICBmaWxlbmFtZTogJ1tuYW1lXS5bY2h1bmtIYXNoOjhdLmNzcycsXG4gICAgfSlcbiAgfVxuICByZXR1cm4ge1xuICAgIG1vZGU6ICdwcm9kdWN0aW9uJyxcbiAgICBjb250ZXh0OiBwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAnLi4vLi4vLi4vbm9kZV9tb2R1bGVzJyksXG4gICAgZW50cnk6IHBhdGgucmVzb2x2ZShST09ULCBjb25maWcuZW50cnkpLFxuICAgIG91dHB1dDoge1xuICAgICAgZmlsZW5hbWU6ICdbbmFtZV0uW2hhc2g6OF0uanMnLCAvLyBkb250IHVzZSBjaHVua2hhc2gsIGl0cyBub3QgYSBjaHVua1xuICAgICAgY2h1bmtGaWxlbmFtZTogJ3RlbXBsYXRlcy9bbmFtZV0uW2NodW5rSGFzaDo4XS5qcycsXG4gICAgICBwYXRoOiBBU1NFVFMsXG4gICAgICBwdWJsaWNQYXRoOiBwcm9jZXNzLmVudi5SRUFDVF9TVEFUSUNfQVNTRVRTX1BBVEggfHwgJy8nLFxuICAgIH0sXG4gICAgb3B0aW1pemF0aW9uOiB7XG4gICAgICBtaW5pbWl6ZTogdHJ1ZSxcbiAgICAgIG1pbmltaXplcjogW1xuICAgICAgICBuZXcgVWdsaWZ5SnNQbHVnaW4oe1xuICAgICAgICAgIGNhY2hlOiB0cnVlLFxuICAgICAgICAgIHBhcmFsbGVsOiB0cnVlLFxuICAgICAgICAgIHNvdXJjZU1hcDogdHJ1ZSwgLy8gc2V0IHRvIHRydWUgaWYgeW91IHdhbnQgSlMgc291cmNlIG1hcHNcbiAgICAgICAgfSksXG4gICAgICAgIG5ldyBPcHRpbWl6ZUNTU0Fzc2V0c1BsdWdpbih7fSksXG4gICAgICBdLFxuICAgICAgc3BsaXRDaHVua3MsXG4gICAgfSxcbiAgICBtb2R1bGU6IHtcbiAgICAgIHJ1bGVzOiBydWxlcyh7IGNvbmZpZywgc3RhZ2U6ICdwcm9kJywgaXNOb2RlOiBmYWxzZSB9KSxcbiAgICB9LFxuICAgIHJlc29sdmU6IHtcbiAgICAgIG1vZHVsZXM6IFtcbiAgICAgICAgU1JDLFxuICAgICAgICBOT0RFX01PRFVMRVMsXG4gICAgICAgICdub2RlX21vZHVsZXMnLFxuICAgICAgICBwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAnLi4vLi4vLi4vbm9kZV9tb2R1bGVzJyksXG4gICAgICAgIERJU1QsXG4gICAgICBdLFxuICAgICAgbWFpbkZpZWxkczogWydicm93c2VyJywgJ21haW4nXSxcbiAgICAgIGV4dGVuc2lvbnM6IFsnLmpzJywgJy5qc29uJywgJy5qc3gnXSxcbiAgICB9LFxuICAgIGV4dGVybmFsczogW10sXG4gICAgdGFyZ2V0OiB1bmRlZmluZWQsXG4gICAgcGx1Z2luczogW1xuICAgICAgbmV3IHdlYnBhY2suRW52aXJvbm1lbnRQbHVnaW4ocHJvY2Vzcy5lbnYpLFxuICAgICAgZXh0cmFja0NTU0NodW5rcyxcbiAgICAgIG5ldyBDYXNlU2Vuc2l0aXZlUGF0aHNQbHVnaW4oKSxcbiAgICAgIGNvbmZpZy5idW5kbGVBbmFseXplciAmJiBuZXcgQnVuZGxlQW5hbHl6ZXJQbHVnaW4oKSxcbiAgICBdLmZpbHRlcihkID0+IGQpLFxuICAgIGRldnRvb2w6ICdzb3VyY2UtbWFwJyxcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbih7IGNvbmZpZywgaXNOb2RlIH0pIHtcbiAgY29uc3QgcmVzdWx0ID0gY29tbW9uKGNvbmZpZylcbiAgaWYgKCFpc05vZGUpIHJldHVybiByZXN1bHRcbiAgcmVzdWx0Lm91dHB1dC5maWxlbmFtZSA9ICdzdGF0aWMuW2NodW5rSGFzaDo4XS5qcydcbiAgcmVzdWx0Lm91dHB1dC5saWJyYXJ5VGFyZ2V0ID0gJ3VtZCdcbiAgcmVzdWx0Lm9wdGltaXphdGlvbi5taW5pbWl6ZSA9IGZhbHNlXG4gIHJlc3VsdC5vcHRpbWl6YXRpb24ubWluaW1pemVyID0gW11cbiAgcmVzdWx0LnRhcmdldCA9ICdub2RlJ1xuICByZXN1bHQuZXh0ZXJuYWxzID0gW1xuICAgIG5vZGVFeHRlcm5hbHMoe1xuICAgICAgd2hpdGVsaXN0OiBbXG4gICAgICAgICdyZWFjdC11bml2ZXJzYWwtY29tcG9uZW50JyxcbiAgICAgICAgJ3dlYnBhY2stZmx1c2gtY2h1bmtzJyxcbiAgICAgICAgJ3JlYWN0LXN0YXRpYy1yb3V0ZXMnLFxuICAgICAgXSxcbiAgICB9KSxcbiAgXVxuICAvL1xuICAvLyBtb2R1bGUucnVsZXNcbiAgcmVzdWx0Lm1vZHVsZS5ydWxlcyA9IHJ1bGVzKHsgY29uZmlnLCBzdGFnZTogJ3Byb2QnLCBpc05vZGU6IHRydWUgfSlcbiAgcmVzdWx0LnBsdWdpbnMgPSBbXG4gICAgbmV3IHdlYnBhY2suRW52aXJvbm1lbnRQbHVnaW4ocHJvY2Vzcy5lbnYpLFxuICAgIG5ldyBDYXNlU2Vuc2l0aXZlUGF0aHNQbHVnaW4oKSxcbiAgICBuZXcgd2VicGFjay5vcHRpbWl6ZS5MaW1pdENodW5rQ291bnRQbHVnaW4oe1xuICAgICAgbWF4Q2h1bmtzOiAxLFxuICAgIH0pLFxuICBdXG4gIHJldHVybiByZXN1bHRcbn1cbiJdfQ==